<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title id="pageTitle">แอปคำนวณต้นทุน - Cost Calculator</title> 

  <link rel="manifest" href="manifest.json"> 
  <link rel="icon" href="icon-192.png" sizes="192x192"> 
  <link rel="apple-touch-icon" sizes="180x180" href="icon-512.png"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
  <meta name="theme-color" content="#4CAF50"> 

  <style>
    /* Base Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      background: linear-gradient(to bottom right, #f0f4f8, #d9e2ec);
      color: #333;
      transition: background 0.4s ease, color 0.4s ease;
      min-height: 100vh;
    }

    /* Dark Mode Styles */
    body.dark {
      background: linear-gradient(to bottom right, #1a1a1a, #2d2d2d);
      color: #f0f0f0;
    }

    .container {
      width: 95%;
      max-width: 750px;
      background: #ffffff;
      padding: 30px;
      border-radius: 24px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      position: relative;
      transition: background 0.4s ease;
    }

    body.dark .container {
      background: #262626;
      box-shadow: 0 15px 35px rgba(0,0,0,0.5);
    }

    h2 { text-align: center; margin-top: 0; color: #4CAF50; }

    .header-controls {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    select, button {
      border-radius: 12px;
      border: 1px solid #ccd6dd;
      font-size: 14px;
      transition: 0.3s;
    }

    button {
      padding: 10px 20px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      font-weight: 600;
    }

    button:hover { background: #45a049; transform: translateY(-1px); }

    /* Theme Button Specific */
    #themeBtn { background: #5d6d7e; }
    body.dark #themeBtn { background: #f39c12; color: #000; }

    details {
      margin: 15px 0;
      border-radius: 15px;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #edf2f7;
    }

    body.dark details {
      background: #333333;
      border-color: #444;
    }

    summary {
      font-weight: bold;
      cursor: pointer;
      padding: 5px;
      outline: none;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
      flex-wrap: nowrap;
    }

    body.dark .input-row { border-bottom-color: #444; }

    .input-row input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      min-width: 0; /* Prevents overflow */
    }

    body.dark .input-row input {
      background: #444;
      color: #fff;
      border-color: #555;
    }

    .arrow-icon {
      font-weight: bold;
      color: #4CAF50;
      font-size: 18px;
      user-select: none;
    }

    #result {
      margin-top: 25px;
      padding: 25px;
      border-radius: 20px;
      background: #eef9f0;
      border: 1px solid #c3e6cb;
      line-height: 1.8;
      font-size: 16px;
    }

    body.dark #result {
      background: #2d3436;
      border-color: #444;
      color: #fff;
    }

    .delete-btn {
      background: #ff7675;
      padding: 8px 12px;
      border-radius: 8px;
    }

    #versionPanel {
      position: fixed;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
    }

    /* Tutorial Pulse */
    .tutorial-btn {
      position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; border-radius: 50%;
      background: #4CAF50; color: white; font-size: 20px; border: none; cursor: pointer;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }

    #tutorialOverlay {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); 
      z-index:9999; align-items:center; justify-content:center;
    }
    .modal { background:#fff; width:90%; max-width:600px; border-radius:20px; padding:10px; position:relative; }
    body.dark .modal { background:#222; }
  </style>
</head>

<body>

  <div class="container">
    <button class="tutorial-btn" onclick="openTutorial()">?</button>

    <div class="header-controls">
      <select id="langSelect" onchange="switchLang()">
        <option value="th">ภาษาไทย</option>
        <option value="en">English</option>
      </select>
      <button id="themeBtn" onclick="toggleDarkMode()">Theme: Auto</button>
    </div>

    <h2 id="title">คำนวณต้นทุนสินค้า</h2>

    <details open>
      <summary id="lblMat">วัตถุดิบ (Materials)</summary>
      <div id="materialsList"></div>
      <button onclick="addMaterialRow()" style="margin-top:10px;">+ เพิ่มรายการ</button>
    </details>

    <details>
      <summary id="lblLabor">ค่าแรง & ค่าใช้จ่าย (Expenses)</summary>
      <div class="input-row">
        <input type="number" inputmode="decimal" id="numWorkers" placeholder="จำนวนคน" oninput="calculateAll()">
        <span class="arrow-icon">→</span>
        <input type="number" inputmode="decimal" id="dailyWage" placeholder="ค่าแรง/คน" oninput="calculateAll()">
      </div>
      <div class="input-row">
        <input type="number" inputmode="decimal" id="waterBill" placeholder="ค่าน้ำ" oninput="calculateAll()">
        <span class="arrow-icon">+</span>
        <input type="number" inputmode="decimal" id="elecBill" placeholder="ค่าไฟ" oninput="calculateAll()">
      </div>
    </details>

    <div style="text-align:center; margin-top:20px;">
      <button onclick="calculateAll()" id="btnCalc" style="width:100%; font-size:18px;">คำนวณ ↓</button>
      <button onclick="resetApp()" style="background:#b2bec3; margin-top:10px;">ล้างข้อมูล</button>
    </div>

    <div id="result">ผลลัพธ์จะแสดงที่นี่...</div>
  </div>

  <div id="versionPanel">Build v2.2.6 | Auto-Save Active</div>

  <div id="tutorialOverlay" onclick="closeTutorial()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 style="text-align:center">คู่มือการใช้งาน</h3>
      <div style="padding:20px; text-align:center;">
        วิดีโอสาธิตการใช้งานแอป<br><br>
        <video id="tutVideo" width="100%" controls>
          <source src="videos/tutorial.mp4" type="video/mp4">
        </video>
      </div>
      <button onclick="closeTutorial()" style="width:100%">ปิด</button>
    </div>
  </div>

  <script>
    let matIndex = 0;

    const langData = {
      th: {
        title: "คำนวณต้นทุนสินค้า", mat: "วัตถุดิบ", labor: "ค่าแรง & ค่าใช้จ่าย",
        placeholderName: "ชื่อวัตถุดิบ", placeholderQty: "จำนวน", placeholderPrice: "ราคา/หน่วย", placeholderProfit: "กำไร/หน่วย",
        resLabor: "ค่าแรงรวม", resOther: "ค่าน้ำ/ไฟ", resMat: "ค่าวัตถุดิบรวม",
        resTotal: "ต้นทุนรวมทั้งหมด ↓", resProfit: "กำไรรวม (+)", resFinal: "ราคาขายรวม →",
        themeAuto: "ตามระบบ", themeDark: "โหมดมืด", themeLight: "โหมดสว่าง",
        confirm: "ลบข้อมูลทั้งหมดหรือไม่?"
      },
      en: {
        title: "Cost Calculator", mat: "Materials", labor: "Labor & Expenses",
        placeholderName: "Item Name", placeholderQty: "Qty", placeholderPrice: "Price/Unit", placeholderProfit: "Profit/Unit",
        resLabor: "Total Labor", resOther: "Utilities", resMat: "Total Materials",
        resTotal: "Total Cost ↓", resProfit: "Total Profit (+)", resFinal: "Final Sale Price →",
        themeAuto: "Auto", themeDark: "Dark Mode", themeLight: "Light Mode",
        confirm: "Clear all data?"
      }
    };

    // --- THEME ENGINE (SET, SAVE, & LISTEN) ---
    function applyTheme() {
      const mode = localStorage.getItem("themePreference") || "auto";
      const isDarkSystem = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const lang = document.getElementById("langSelect").value;
      const btn = document.getElementById("themeBtn");

      if (mode === "dark") {
        document.body.classList.add("dark");
        btn.textContent = langData[lang].themeDark;
      } else if (mode === "light") {
        document.body.classList.remove("dark");
        btn.textContent = langData[lang].themeLight;
      } else {
        // Auto Mode
        document.body.classList.toggle("dark", isDarkSystem);
        btn.textContent = langData[lang].themeAuto;
      }
    }

    function toggleDarkMode() {
      const current = localStorage.getItem("themePreference") || "auto";
      let next = "auto";
      if (current === "auto") next = "dark";
      else if (current === "dark") next = "light";
      
      localStorage.setItem("themePreference", next);
      applyTheme();
    }

    // Live Listener: If user changes system settings while app is open
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (localStorage.getItem("themePreference") === "auto" || !localStorage.getItem("themePreference")) {
        applyTheme();
      }
    });

    // --- APP LOGIC ---
    function addMaterialRow(name="", qty="", price="", profit="") {
      matIndex++;
      const lang = document.getElementById("langSelect").value;
      const container = document.getElementById("materialsList");
      const div = document.createElement("div");
      div.className = "input-row";
      div.id = "row-" + matIndex;
      div.innerHTML = `
        <input type="text" placeholder="${langData[lang].placeholderName}" value="${name}" style="flex:1.5" oninput="saveData()">
        <span class="arrow-icon">→</span>
        <input type="number" inputmode="decimal" placeholder="${langData[lang].placeholderQty}" value="${qty}" oninput="calculateAll()">
        <span class="arrow-icon">→</span>
        <input type="number" inputmode="decimal" placeholder="${langData[lang].placeholderPrice}" value="${price}" oninput="calculateAll()">
        <span class="arrow-icon">+</span>
        <input type="number" inputmode="decimal" placeholder="${langData[lang].placeholderProfit}" value="${profit}" oninput="calculateAll()">
        <button class="delete-btn" onclick="removeRow(${matIndex})">×</button>
      `;
      container.appendChild(div);
      saveData();
    }

    function removeRow(id) {
      document.getElementById("row-"+id).remove();
      saveData();
      calculateAll();
    }

    function calculateAll() {
      const lang = document.getElementById("langSelect").value;
      const l = langData[lang];
      const currency = lang === "th" ? " ฿" : " $";

      // Fixed Expenses
      const workers = parseFloat(document.getElementById("numWorkers").value) || 0;
      const wage = parseFloat(document.getElementById("dailyWage").value) || 0;
      const water = parseFloat(document.getElementById("waterBill").value) || 0;
      const electricity = parseFloat(document.getElementById("elecBill").value) || 0;

      const totalLabor = workers * wage;
      const totalOther = water + electricity;

      // Materials Calculation
      let totalMatCost = 0;
      let totalProfit = 0;
      let hasMat = false;

      document.querySelectorAll("#materialsList .input-row").forEach(row => {
        const q = parseFloat(row.children[2].value) || 0;
        const p = parseFloat(row.children[4].value) || 0;
        const pr = parseFloat(row.children[6].value) || 0;
        if (q > 0 || p > 0) hasMat = true;
        totalMatCost += (q * p);
        totalProfit += (q * pr);
      });

      const grandTotalCost = totalLabor + totalOther + totalMatCost;
      const finalSalePrice = grandTotalCost + totalProfit;

      // Build Result UI
      if (!hasMat && grandTotalCost === 0) {
        document.getElementById("result").innerHTML = "รอข้อมูล...";
        return;
      }

      let html = "";
      if (totalLabor > 0) html += `${l.resLabor}: <strong>${totalLabor.toLocaleString()}${currency}</strong><br>`;
      if (totalOther > 0) html += `${l.resOther}: <strong>${totalOther.toLocaleString()}${currency}</strong><br>`;
      if (totalMatCost > 0) html += `${l.resMat}: <strong>${totalMatCost.toLocaleString()}${currency}</strong><br>`;
      html += `<hr>${l.resTotal} <strong>${grandTotalCost.toLocaleString()}${currency}</strong><br>`;
      if (totalProfit > 0) html += `${l.resProfit} <strong>${totalProfit.toLocaleString()}${currency}</strong><br>`;
      html += `<br><div style="font-size:22px; color:#4CAF50;">${l.resFinal} <strong>${finalSalePrice.toLocaleString()}${currency}</strong></div>`;

      document.getElementById("result").innerHTML = html;
      saveData();
    }

    // --- DATA PERSISTENCE ---
    function saveData() {
      const data = {
        workers: document.getElementById("numWorkers").value,
        wage: document.getElementById("dailyWage").value,
        water: document.getElementById("waterBill").value,
        elec: document.getElementById("elecBill").value,
        materials: []
      };
      document.querySelectorAll("#materialsList .input-row").forEach(row => {
        data.materials.push({
          n: row.children[0].value,
          q: row.children[2].value,
          p: row.children[4].value,
          pr: row.children[6].value
        });
      });
      localStorage.setItem("appData", JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem("appData");
      if (!saved) { addMaterialRow(); return; }
      const data = JSON.parse(saved);
      document.getElementById("numWorkers").value = data.workers;
      document.getElementById("dailyWage").value = data.wage;
      document.getElementById("waterBill").value = data.water;
      document.getElementById("elecBill").value = data.elec;
      data.materials.forEach(m => addMaterialRow(m.n, m.q, m.p, m.pr));
    }

    function switchLang() {
      const lang = document.getElementById("langSelect").value;
      localStorage.setItem("userLang", lang);
      location.reload(); // Cleanest way to refresh all translated placeholders
    }

    function resetApp() {
      if (confirm(langData[document.getElementById("langSelect").value].confirm)) {
        localStorage.removeItem("appData");
        location.reload();
      }
    }

    function openTutorial() { document.getElementById("tutorialOverlay").style.display = "flex"; }
    function closeTutorial() { 
      document.getElementById("tutorialOverlay").style.display = "none"; 
      document.getElementById("tutVideo").pause();
    }

    // Initial Load
    window.onload = () => {
      const savedLang = localStorage.getItem("userLang") || "th";
      document.getElementById("langSelect").value = savedLang;
      document.getElementById("title").textContent = langData[savedLang].title;
      loadData();
      applyTheme();
      calculateAll();
    };
  </script>
</body>
</html>
